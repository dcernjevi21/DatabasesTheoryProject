<!DOCTYPE html>
<html lang="hr" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <title>DJ Tour Manager Pro</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- MarkerCluster CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />

    <style>
        body { height: 100vh; display: flex; flex-direction: column; background-color: #212529; color: #f8f9fa; }
        
        .main-container { flex: 1; display: flex; overflow: hidden; }
        
        /* Dark Sidebar */
        .sidebar { 
            width: 380px; 
            background: #2b3035; 
            border-right: 1px solid #495057; 
            padding: 15px; 
            overflow-y: auto; 
            z-index: 1000; 
        }
        
        /* Map container background */
        #map { flex: 1; background: #ddd; }
        

        /* Prilagodba Popupa da budu tamni */
        .leaflet-popup-content-wrapper, .leaflet-popup-tip {
            background-color: #343a40;
            color: #e9ecef;
            box-shadow: 0 3px 14px rgba(0,0,0,0.4);
        }
        .leaflet-container a.leaflet-popup-close-button {
            color: #b0b0b0;
        }

        /* Label kluba */
        .club-label {
            background: rgba(33, 37, 41, 0.9);
            border: 1px solid #adb5bd;
            color: #fff;
            border-radius: 3px;
            padding: 0 4px; 
            font-size: 11px; 
            font-weight: bold; 
            white-space: nowrap;
        }
        
        /* Tabovi */
        .nav-tabs .nav-link { color: #adb5bd; }
        .nav-tabs .nav-link.active { 
            font-weight: bold; 
            background-color: #2b3035; 
            border-color: #495057 #495057 #2b3035; 
            color: #0d6efd; 
        }
        .nav-tabs { border-bottom: 1px solid #495057; }

        .form-check-input:checked { background-color: #0d6efd; border-color: #0d6efd; }
        
        input[readonly] { background-color: #212529 !important; border-color: #495057; }
    </style>
</head>
<body>

<!-- Navbar -->
<nav class="navbar navbar-dark bg-dark border-bottom border-secondary px-3 py-2 shadow-sm d-flex justify-content-between align-items-center">
    <ul class="nav nav-tabs border-0" id="myTab" role="tablist">
        <li class="nav-item">
            <button class="nav-link active border-0" id="tour-tab" onclick="switchMode('tour')">Prikaz turneja</button>
        </li>
        <li class="nav-item">
            <button class="nav-link border-0" id="add-tab" onclick="switchMode('add')">Unos ga≈æe</button>
        </li>
    </ul>
    
    <div>
        <button class="btn btn-outline-warning btn-sm fw-bold me-2" onclick="showTopList()">Top Klubovi</button>
        <button class="btn btn-outline-danger btn-sm fw-bold" onclick="lockMonth()">Zakljuƒçaj Mjesec</button>
    </div>

    <div class="form-check form-switch ms-3">
        <input class="form-check-input" type="checkbox" id="regionToggle" checked onchange="toggleRegions()">
        <label class="form-check-label small fw-bold text-light" for="regionToggle">≈Ωupanije</label>
    </div>
</nav>

<div class="main-container">
    <!-- SIDEBAR -->
    <div class="sidebar shadow">
        
        <!-- Turneje -->
        <div id="tour-view">
            <h5 class="mb-3 fw-bold text-primary">Analiza Turneje</h5>
            <select id="monthSelect" class="form-select mb-3 shadow-sm bg-dark text-light border-secondary"></select>
            
            <div class="card p-3 mb-3 bg-dark text-light border-primary border-start border-4">
                <div class="d-flex justify-content-between"><span>Broj ga≈æa:</span> <strong id="sCount">0</strong></div>
                <div class="d-flex justify-content-between"><span>Profit:</span> <strong id="sProfit" class="text-success">0 ‚Ç¨</strong></div>
                <hr class="my-2 border-secondary">
                <div class="d-flex justify-content-between"><span>Ukupni put:</span> <strong id="sKm">0 km</strong></div>
            </div>
            
            <h6 class="border-bottom border-secondary pb-2 mb-2">Lista nastupa</h6>
            <div class="list-group list-group-flush small" id="gigList"></div>
        </div>

        <!-- Unos -->
        <div id="add-view" style="display: none;">
            <h5 class="mb-3 fw-bold text-success">Baza & Unos</h5>
            <div class="alert alert-info small py-2 mb-3 bg-dark text-info border-info">
                Klikni na <strong>sivi marker</strong> (postojeƒái) ili <strong>prazno</strong> (novi).
            </div>
            
            <form id="addForm" class="card p-3 shadow-sm border-secondary bg-dark text-light">
                <input type="hidden" id="inKlubId"> 
                
                <h6 class="border-bottom border-secondary pb-2 mb-3">Klub</h6>
                <div class="mb-2">
                    <label class="small fw-bold">Naziv</label>
                    <input type="text" id="inNaziv" class="form-control form-control-sm bg-dark text-light border-secondary" required>
                </div>
                <div class="mb-2">
                    <label class="small">Adresa</label>
                    <input type="text" id="inAdresa" class="form-control form-control-sm bg-dark text-light border-secondary">
                </div>
                <div class="row g-2 mb-2">
                    <div class="col-6"><input type="text" id="inLat" class="form-control form-control-sm" readonly></div>
                    <div class="col-6"><input type="text" id="inLon" class="form-control form-control-sm" readonly></div>
                </div>

                <h6 class="border-bottom border-secondary pb-2 mt-3 mb-3">Ga≈æa</h6>
                <div class="mb-2">
                    <label class="small fw-bold">Datum</label>
                    <input type="date" id="inDatum" class="form-control form-control-sm bg-dark text-light border-secondary" required>
                </div>
                <div class="row g-2 mb-2">
                    <div class="col-6"><label class="small">Honorar</label><input type="number" id="inHonorar" class="form-control form-control-sm bg-dark text-light border-secondary" value="0"></div>
                    <div class="col-6"><label class="small">Tro≈°ak</label><input type="number" id="inTrosak" class="form-control form-control-sm bg-dark text-light border-secondary" value="0"></div>
                </div>
                <div class="mb-3">
                    <label class="small">Tip</label>
                    <select id="inKat" class="form-select form-select-sm bg-dark text-light border-secondary">
                        <option value="1">Klub</option><option value="2">Festival</option><option value="3">Bar</option><option value="4">Vjenƒçanje</option>
                    </select>
                </div>
                
                <button type="submit" class="btn btn-success w-100 fw-bold">Spremi</button>
                <button type="button" onclick="resetForm()" class="btn btn-outline-secondary w-100 mt-2 btn-sm">Oƒçisti</button>
            </form>
        </div>
    </div>

    <!-- karta -->
    <div id="map"></div>
</div>

<!-- Ureƒëivanje ga≈æa -->
<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog modal-sm">
        <div class="modal-content bg-dark text-light border-secondary">
            <div class="modal-header border-secondary"><h6 class="modal-title">‚úèÔ∏è Uredi Ga≈æu</h6><button class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <input type="hidden" id="editId">
                <div class="mb-2"><label class="small fw-bold">Novi Honorar</label><input type="number" id="editHonorar" class="form-control bg-dark text-light border-secondary"></div>
                <div class="mb-2"><label class="small fw-bold">Novi Tro≈°ak</label><input type="number" id="editTrosak" class="form-control bg-dark text-light border-secondary"></div>
                <button onclick="saveEdit()" class="btn btn-primary w-100">A≈æuriraj</button>
            </div>
        </div>
    </div>
</div>

<!-- Top lista -->
<div class="modal fade" id="topModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-light border-secondary">
            <div class="modal-header border-secondary"><h5 class="modal-title">Top 5 Klubova</h5><button class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <ul class="list-group list-group-flush" id="topList"></ul>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

<script>
    var map = L.map('map').setView([44.5, 16.0], 7);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    var regionLayer = L.layerGroup().addTo(map);
    var tourLayer = L.layerGroup().addTo(map);
    var routeLayer = L.layerGroup().addTo(map);
    var clubCluster = L.markerClusterGroup({ showCoverageOnHover: false, zoomToBoundsOnClick: true, spiderfyOnMaxZoom: true }).addTo(map);

    var tempMarker = null;
    var currentMode = 'tour'; 
    var editModal = new bootstrap.Modal(document.getElementById('editModal'));
    var topModal = new bootstrap.Modal(document.getElementById('topModal'));

    loadRegions(); 
    loadMonths();

    function loadRegions() {
        fetch('/api/regions').then(r => r.json()).then(data => {
            L.geoJSON(data, {
                style: { color: '#3388ff', weight: 1, fillColor: '#3388ff', fillOpacity: 0.1 },
                onEachFeature: (f, l) => l.bindTooltip(f.properties.naziv, {permanent: false, direction: "center", className: "text-primary fw-bold bg-dark border-secondary"})
            }).addTo(regionLayer);
        });
    }

    function toggleRegions() {
        if(document.getElementById('regionToggle').checked) map.addLayer(regionLayer); else map.removeLayer(regionLayer);
    }

    function switchMode(mode) {
        currentMode = mode;
        document.querySelectorAll('.nav-link').forEach(b => b.classList.remove('active'));
        document.getElementById(mode + '-tab').classList.add('active');
        document.getElementById('tour-view').style.display = mode === 'tour' ? 'block' : 'none';
        document.getElementById('add-view').style.display = mode === 'add' ? 'block' : 'none';

        tourLayer.clearLayers(); routeLayer.clearLayers(); clubCluster.clearLayers();
        if(tempMarker) map.removeLayer(tempMarker);

        if(mode === 'tour') loadTourData(); else loadAllClubs(); 
    }

    function loadTourData() {
        const m = document.getElementById('monthSelect').value; if(!m) return;
        tourLayer.clearLayers(); routeLayer.clearLayers();

        fetch(`/api/stats?month=${m}`).then(r=>r.json()).then(s => {
            document.getElementById('sCount').innerText = s.broj;
            document.getElementById('sProfit').innerText = s.profit.toFixed(2) + ' ‚Ç¨';
            document.getElementById('sKm').innerText = s.km + ' km';
        });

        fetch(`/api/gigs?month=${m}`).then(r=>r.json()).then(data => {
            const list = document.getElementById('gigList'); list.innerHTML = '';
            
            L.geoJSON(data, {
                pointToLayer: (f, ll) => L.circleMarker(ll, {
                    radius: 8, fillColor: f.properties.boja, color: '#fff', weight: 2, fillOpacity: 1
                }),
                onEachFeature: (f, l) => {
                    let btn = f.properties.locked 
                        ? '<span class="badge bg-secondary w-100 mt-2">üîí Zakljuƒçano</span>' 
                        : `<button class="btn btn-sm btn-outline-primary mt-2 w-100" onclick="openEdit(${f.properties.id}, ${f.properties.honorar}, ${f.properties.troskovi})">‚úèÔ∏è Uredi</button>`;

                    const popupContent = `
                        <div class="text-center">
                            <strong>${f.properties.naziv}</strong><br>
                            <span class="text-light small">${f.properties.datum}</span><br>
                            <hr class="my-1 border-secondary">
                            Honorar: <b>${f.properties.honorar} ‚Ç¨</b><br>
                            Tro≈°ak: <b>${f.properties.troskovi} ‚Ç¨</b>
                            ${btn}
                        </div>`;
                    
                    l.bindPopup(popupContent);

                    let listEditBtn = f.properties.locked 
                        ? '<span title="Zakljuƒçano">üîí</span>' 
                        : `<button class="btn btn-sm btn-dark border-secondary border py-0 px-1" title="Uredi" onclick="event.stopPropagation(); openEdit(${f.properties.id}, ${f.properties.honorar}, ${f.properties.troskovi})">‚úèÔ∏è</button>`;

                    list.innerHTML += `
                        <div class="list-group-item list-group-item-action bg-dark text-light border-secondary py-2" style="cursor: pointer;" onclick="zoomTo(${l.getLatLng().lat}, ${l.getLatLng().lng})">
                            <div class="d-flex w-100 justify-content-between align-items-center">
                                <div><h6 class="mb-0 fw-bold" style="color:${f.properties.boja}">${f.properties.naziv}</h6><small class="text-muted">${f.properties.datum}</small></div>
                                <div class="text-end"><span class="fw-bold text-success d-block">${(f.properties.honorar - f.properties.troskovi).toFixed(0)} ‚Ç¨</span>${listEditBtn}</div>
                            </div>
                        </div>`;
                }
            }).addTo(tourLayer);
        });

        fetch(`/api/route?month=${m}`).then(r=>r.json()).then(d => {
            if(d.geometry) {
                // Ruta crna (ili tamno siva) jer je mapa svijetla
                L.geoJSON(d, {style: {color:'#333', dashArray:'5,10', weight: 3}}).addTo(routeLayer);
                const bounds = L.geoJSON(d).getBounds();
                if(bounds.isValid()) map.fitBounds(bounds, {padding: [50, 50]});
            }
        });
    }

    function loadAllClubs() {
        fetch('/api/clubs').then(r=>r.json()).then(data => {
            const geoJsonLayer = L.geoJSON(data, {
                pointToLayer: (f, latlng) => L.circleMarker(latlng, {radius: 7, fillColor: '#6c757d', color: '#343a40', weight: 1, fillOpacity: 0.8}),
                onEachFeature: (f, layer) => {
                    layer.bindTooltip(f.properties.naziv, {permanent: true, direction: 'top', offset: [0, -10], className: 'club-label'});
                    layer.on('click', e => { L.DomEvent.stop(e); fillForm(f.properties, e.latlng); });
                }
            });
            clubCluster.addLayer(geoJsonLayer);
        });
    }

    window.openEdit = (id, h, t) => { 
        document.getElementById('editId').value = id; 
        document.getElementById('editHonorar').value = h; 
        document.getElementById('editTrosak').value = t; 
        editModal.show(); 
    };

    window.saveEdit = () => {
        const id = document.getElementById('editId').value;
        const body = {honorar: document.getElementById('editHonorar').value, trosak: document.getElementById('editTrosak').value};
        fetch(`/api/gigs/${id}`, {method:'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body)})
        .then(r=>r.json()).then(res => { 
            if(res.error) alert(res.error); else { editModal.hide(); loadTourData(); }
        });
    };

    window.showTopList = () => {
        fetch('/api/top').then(r=>r.json()).then(d => {
            const l = document.getElementById('topList'); l.innerHTML = '';
            d.forEach((k, i) => l.innerHTML += `<li class="list-group-item bg-dark text-light border-secondary d-flex justify-content-between align-items-center"><span>${i+1}. <strong>${k.naziv}</strong> <small class="text-muted">(${k.regija})</small></span> <span class="badge bg-primary rounded-pill">${k.profit} ‚Ç¨</span></li>`);
            topModal.show();
        });
    };

    window.lockMonth = () => {
        const m = document.getElementById('monthSelect').value;
        if(confirm(`Sigurno zakljuƒçati mjesec ${m}? Podaci se vi≈°e neƒáe moƒái mijenjati!`)) {
            fetch('/api/lock', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({month:m})})
            .then(r=>r.json()).then(res => { if(res.success) { alert('Zakljuƒçano!'); loadTourData(); } else alert(res.error); });
        }
    };

    map.on('click', e => { if(currentMode==='add') fillForm(null, e.latlng); });
    function zoomTo(lat, lon) { map.setView([lat, lon], 12); }
    function fillForm(p, ll) {
        if(tempMarker) map.removeLayer(tempMarker); tempMarker = L.marker(ll).addTo(map);
        document.getElementById('inLat').value = ll.lat.toFixed(5); document.getElementById('inLon').value = ll.lng.toFixed(5);
        if(p) { document.getElementById('inKlubId').value=p.id; document.getElementById('inNaziv').value=p.naziv; document.getElementById('inAdresa').value=p.adresa||''; document.getElementById('inNaziv').readOnly=true; document.getElementById('inAdresa').readOnly=true; }
        else { resetForm(); document.getElementById('inLat').value = ll.lat.toFixed(5); document.getElementById('inLon').value = ll.lng.toFixed(5); }
    }
    function resetForm() { document.getElementById('addForm').reset(); document.getElementById('inKlubId').value=""; document.getElementById('inNaziv').readOnly=false; document.getElementById('inAdresa').readOnly=false; if(tempMarker) map.removeLayer(tempMarker); }

    function loadMonths() { fetch('/api/months').then(r=>r.json()).then(d => { 
        const s=document.getElementById('monthSelect'); s.innerHTML=''; d.forEach(m=>s.add(new Option(m.naziv, m.id))); 
        if(currentMode==='tour') loadTourData();
    }); }
    document.getElementById('monthSelect').addEventListener('change', loadTourData);

    document.getElementById('addForm').addEventListener('submit', e => {
        e.preventDefault();
        fetch('/api/add', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({
            klub_id:document.getElementById('inKlubId').value, naziv:document.getElementById('inNaziv').value, adresa:document.getElementById('inAdresa').value,
            lat:document.getElementById('inLat').value, lon:document.getElementById('inLon').value, datum:document.getElementById('inDatum').value,
            honorar:document.getElementById('inHonorar').value, trosak:document.getElementById('inTrosak').value, kat:document.getElementById('inKat').value
        })}).then(r=>r.json()).then(res => { 
            if(res.error) alert(res.error); else { alert('Spremljeno!'); resetForm(); loadMonths(); if(currentMode==='add') loadAllClubs(); }
        });
    });
</script>
</body>
</html>